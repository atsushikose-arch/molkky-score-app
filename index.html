<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="モルックスコア">
<title>みんなとモルックスコア</title>
<link href="https://fonts.googleapis.com/css2?family=Rounded+M+1c:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
    margin: 0;
    font-family: 'Rounded M+ 1c', sans-serif;
    background: #0d1f0d;
    color: #fff;
    height: 100vh;
    display: flex;
    flex-direction: column;
}
.container {
    display: flex;
    flex-direction: column;
    flex: 1 1 auto;
    justify-content: flex-start;
}
.top {
    display: flex;
    flex-wrap: nowrap;
    padding: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    flex: 0 1 auto;
    overflow: hidden;
    justify-content: center;
}
.team {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 5px;
    min-width: 120px;
    box-sizing: border-box;
    border: 2px solid transparent;
    border-radius: 12px;
}
.team.selected { border: 2px solid #7ed321; background: rgba(126,211,33,0.12); }
.team-name {
    margin-bottom: 0;
    text-align: center;
    line-height: 1.2;
    font-size: 36px;
    border: none;
    background: transparent;
    font-weight: bold;
    width: 100%;
    color: #fff;
}
.team-name:focus { outline: none; border-bottom: 1px solid rgba(255,255,255,0.3); }
.score-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2vmin;
    margin: 0;
}
.score {
    display: flex;
    gap: 6px;
    justify-content: center;
    align-items: center;
    max-height: 20vh;
}
.score img {
    height: 18vh !important;
    width: auto !important;
}
.misses {
    display: flex;
    flex-direction: column;
    gap: 5px;
    flex-shrink: 0;
}
.miss {
    font-size: 8vmin;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    color: rgba(255,255,255,0.2);
    line-height: 1;
}
.miss.active {
    color: #ff5252;
    font-weight: bold;
}
.bottom {
    display: flex;
    flex-direction: column;
    padding: 5px;
    gap: 5px;
}
.controls {
    display: flex;
    flex-direction: row;
    gap: 5px;
    justify-content: space-around;
    flex-wrap: wrap;
    margin-bottom: 3vmin;
}
.controls button {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.2);
    cursor: pointer;
    flex-grow: 1;
    background: rgba(255,255,255,0.08);
    color: #fff;
}
.mode-toggle {
    background: rgba(126,211,33,0.15);
    padding: 4px 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 12px;
    cursor: pointer;
    border-radius: 20px;
    border: 1px solid #7ed321;
    color: #7ed321;
    user-select: none;
    flex-grow: 1;
}
.theme-selector {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.2);
    flex-grow: 1;
    background: rgba(255,255,255,0.08);
    color: #fff;
}
.keys-area {
    display: flex;
    gap: 3vmin;
    margin-top: 1vmin;
}
.keys {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(10vmin, 1fr));
    grid-auto-rows: 10vmin;
    gap: 10vmin;
}
.key {
    border: none;
    border-radius: 14px;
    background: #1e4020;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 8vmin;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    color: #fff;
    box-shadow: 0 4px 0 #0a1a0a;
}
.key:active {
    background: #7ed321;
    color: #0d1f0d;
    transform: scale(0.95);
    box-shadow: none;
}
.undo-button {
    min-width: 15vmin;
    background: #ff6d00;
    color: white;
    font-weight: bold;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    user-select: none;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 0.5vmin;
    padding: 1vmin;
    box-shadow: 0 4px 0 #b34d00;
}
.undo-button .icon {
    font-size: 6vmin;
    line-height: 1;
}
.undo-button .text {
    font-size: 3.5vmin;
    line-height: 1;
}
.undo-button:active {
    background: #e65100;
    transform: scale(0.95);
    box-shadow: none;
}
.version {
    font-size: 14px;
    text-align: center;
    margin: 2px 0;
    color: rgba(255,255,255,0.25);
}
@media screen and (orientation: landscape) {
    .container { flex-direction: column; }
    .bottom { flex-direction: column; }
    .controls { flex-direction: row; flex-wrap: wrap; }
    .keys-area {
        margin-top: 1vmin;
    }
    .keys {
        grid-template-columns: repeat(6, 1fr);
        grid-auto-rows: 6vmin;
        gap: 6vmin;
    }
    .key {
        font-size: 4vmin;
    }
    .undo-button {
        min-width: 10vmin;
    }
    .undo-button .icon {
        font-size: 4vmin;
    }
    .undo-button .text {
        font-size: 2.5vmin;
    }
    .score {
        max-height: 35vh;
    }
    .score img {
        height: 30vh !important;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="top" id="top"></div>
    <div class="bottom">
        <div class="controls">
            <button onclick="addTeam()">Team ＋</button>
            <button onclick="removeTeam()">Team −</button>
            <div id="modeToggle" class="mode-toggle">Mode</div>
            <button onclick="forceReload()">再読込</button>
            <button onclick="resetScores()" style="color:#ff5252;">得点リセット</button>
            <!-- ★ テーマ選択 -->
            <select id="themeSelector" class="theme-selector" onchange="changeTheme(this.value)">
                <option value="">default</option>
                <option value="numbers_colorful">colorful</option>
                <option value="numbers_tokyotower">tokyo tower</option>
                <option value="numbers_gradation">gradation</option>
                <option value="numbers_tokyotowerwalking">tokyo tower walking</option>
                <option value="numbers_minato-ku">minato-ku</option>
                <option value="numbers_manga">manga</option>
                <option value="numbers_stone">stone</option>
                <option value="numbers_working">working</option>
            </select>
        </div>
        <div class="keys-area">
            <div class="keys" id="keys"></div>
            <button class="undo-button" onclick="undo()">
                <span class="icon">↩</span>
                <span class="text">1つ前に戻す</span>
            </button>
        </div>
        <div class="version">Ver 1.5.0</div>
    </div>
</div>

<script>
let teams = [
    { name: "チームA", score: 0, misses: 0 },
    { name: "チームB", score: 0, misses: 0 },
];
let selectedTeam = 0;
let addMode = true;
let history = [];
let currentTheme = ""; // デフォルトは直下

const topElement = document.getElementById("top");
const keys = document.getElementById("keys");
const modeToggle = document.getElementById("modeToggle");

function getScoreImageURL(digit) {
    if (currentTheme === "") {
        return `https://github.com/atsushikose-arch/molkky-score-images/raw/main/score_${digit}.png`;
    } else {
        return `https://github.com/atsushikose-arch/molkky-score-images/raw/main/${currentTheme}/score_${digit}.png`;
    }
}

function renderScore(team) {
    const scoreDiv = document.createElement("div");
    scoreDiv.className = "score";
    const digits = team.score.toString().split("");
    digits.forEach(d => {
        const img = document.createElement("img");
        img.src = getScoreImageURL(d);
        img.alt = d;
        scoreDiv.appendChild(img);
    });
    return scoreDiv;
}

function render() {
    topElement.innerHTML = "";
    teams.forEach((team, index) => {
        const div = document.createElement("div");
        div.className = "team" + (index === selectedTeam ? " selected" : "");

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.className = "team-name";
        nameInput.value = team.name;
        nameInput.addEventListener("input", (e) => { team.name = e.target.value; });

        const scoreImg = renderScore(team);

        const misses = document.createElement("div");
        misses.className = "misses";
        for (let i = 0; i < 3; i++) {
            const miss = document.createElement("div");
            miss.className = "miss" + (i < team.misses ? " active" : "");
            miss.textContent = "×";
            miss.onclick = (e) => {
                e.stopPropagation();
                team.misses += i < team.misses ? -1 : 1;
                render();
            };
            misses.appendChild(miss);
        }

        const scoreRow = document.createElement("div");
        scoreRow.className = "score-row";
        scoreRow.appendChild(scoreImg);
        scoreRow.appendChild(misses);

        div.appendChild(nameInput);
        div.appendChild(scoreRow);
        div.onclick = (e) => {
        // 入力フィールドをクリックした場合は処理しない
        if (e.target.classList.contains("team-name")) return;
        selectedTeam = index;
        render();
        };
        topElement.appendChild(div);
    });
    updateModeDisplay();
}

function updateModeDisplay() {
    modeToggle.textContent = addMode ? "加点 Mode" : "減点 Mode";
}
modeToggle.onclick = () => { addMode = !addMode; updateModeDisplay(); };

function createKeys() {
    if (!keys.hasChildNodes()) {
        for (let i = 1; i <= 12; i++) {
            const btn = document.createElement("div");
            btn.className = "key";
            btn.textContent = i;
            btn.onclick = () => applyScore(i);
            keys.appendChild(btn);
        }
    }
}

function applyScore(value) {
    const team = teams[selectedTeam];
    history.push(JSON.parse(JSON.stringify(teams)));
    if (addMode) {
        team.score += value;
        if (team.score > 50) team.score = 25;
        team.misses = 0;
    } else {
        team.score = Math.max(0, team.score - value);
    }
    render();
}

function addTeam() {
    if (teams.length >= 10) return;
    teams.push({ name: `チーム${String.fromCharCode(65 + teams.length)}`, score: 0, misses: 0 });
    render();
}
function removeTeam() {
    if (teams.length <= 1) return;
    teams.splice(selectedTeam,1);
    selectedTeam=Math.max(0, teams.length-1);
    render();
}
function undo() {
    if (history.length === 0) return;
    teams = history.pop();
    selectedTeam=Math.min(selectedTeam, teams.length-1);
    render();
}
function changeTheme(theme) {
    currentTheme = theme;
    render();
}
function forceReload() {
    if (!confirm('最新版にリロードしますか？\n（チーム名・チーム数・スコアがすべてリセットされます。元に戻せません）')) return;
    const url = location.href.split('?')[0] + '?v=' + Date.now();
    location.href = url;
}
function resetScores() {
    if (!confirm('全チームの得点とミスをゼロにリセットしますか？')) return;
    history.push(JSON.parse(JSON.stringify(teams)));
    teams.forEach(t => { t.score = 0; t.misses = 0; });
    render();
}

render();
createKeys();
window.addEventListener("resize", render);
</script>
</body>
</html>
