<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="„É¢„É´„ÉÉ„ÇØ„Çπ„Ç≥„Ç¢">
<title>„Åø„Çì„Å™„Å®„É¢„É´„ÉÉ„ÇØ„Çπ„Ç≥„Ç¢</title>
<link href="https://fonts.googleapis.com/css2?family=Rounded+M+1c:wght@400;700&display=swap" rel="stylesheet">
<style>
body {
    margin: 0;
    font-family: 'Rounded M+ 1c', sans-serif;
    background: #f0f2f5;
    color: #1a1a1a;
    height: 100vh;
    display: flex;
    flex-direction: column;
}
.container {
    display: flex;
    flex-direction: column;
    flex: 1 1 auto;
    justify-content: flex-start;
}
.top {
    display: flex;
    flex-wrap: nowrap;
    padding: 10px;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    flex: 0 1 auto;
    overflow: hidden;
    justify-content: center;
}
.team {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    padding: 5px 4px;
    min-width: 120px;
    box-sizing: border-box;
    border-bottom: 3px solid transparent;
}
.team.selected { border-bottom: 3px solid #f9a825; background: #fff176; }
.team-main {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
}
.member-list {
    display: flex;
    flex-direction: column;
    padding-top: 3px;
    margin-right: 3px;
    flex-shrink: 0;
    width: 11vmin;
}
.member-input {
    font-size: 3vmin;
    font-family: 'Rounded M+ 1c', sans-serif;
    width: 100%;
    border: none;
    border-bottom: 1px solid #e0e0e0;
    background: transparent;
    color: #aaa;
    padding: 0;
    margin: 1px 0;
    outline: none;
    box-sizing: border-box;
}
.member-input::placeholder {
    color: #ddd;
}
.member-input.current {
    color: #e53935;
    font-weight: bold;
}
.team-name {
    margin-bottom: 0;
    text-align: center;
    line-height: 1.2;
    font-size: 36px;
    border: none;
    background: transparent;
    font-weight: bold;
    width: 100%;
    color: #1a1a1a;
}
.team-name:focus { outline: none; border-bottom: 1px solid #aaa; }
.score-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2vmin;
    margin: 0;
}
.score {
    display: flex;
    gap: 6px;
    justify-content: center;
    align-items: center;
    max-height: 20vh;
}
.score img {
    height: 14vh !important;
    width: auto !important;
}
.misses {
    display: flex;
    flex-direction: column;
    gap: 5px;
    flex-shrink: 0;
}
.miss {
    font-size: 6vmin;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    color: #ddd;
    line-height: 1;
}
.miss.active {
    color: #e53935;
    font-weight: bold;
}
.bottom {
    display: flex;
    flex-direction: column;
    padding: 5px;
    gap: 5px;
}
.controls {
    display: flex;
    flex-direction: row;
    gap: 5px;
    justify-content: space-around;
    flex-wrap: wrap;
    margin-bottom: 3vmin;
}
.controls button {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 20px;
    border: none;
    cursor: pointer;
    flex-grow: 1;
    background: #e0e0e0;
    color: #333;
    font-weight: bold;
}
.mode-toggle {
    background: #1565c0;
    padding: 4px 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 12px;
    cursor: pointer;
    border-radius: 20px;
    border: none;
    color: #fff;
    user-select: none;
    flex-grow: 1;
    font-weight: bold;
}
.theme-selector {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 20px;
    border: none;
    flex-grow: 1;
    background: #e0e0e0;
    color: #333;
}
.keys-area {
    display: flex;
    gap: 3vmin;
    margin-top: 1vmin;
}
.keys {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(10vmin, 1fr));
    grid-auto-rows: 10vmin;
    gap: 10vmin;
}
.key {
    border: none;
    border-radius: 14px;
    background: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 8vmin;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    color: #1a1a1a;
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
}
.key:active {
    background: #1565c0;
    color: #fff;
    transform: scale(0.95);
    box-shadow: none;
}
.undo-button {
    min-width: 15vmin;
    background: #1565c0;
    color: white;
    font-weight: bold;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    user-select: none;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 0.5vmin;
    padding: 1vmin;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.undo-button .icon {
    font-size: 6vmin;
    line-height: 1;
}
.undo-button .text {
    font-size: 3.5vmin;
    line-height: 1;
}
.undo-button:active {
    background: #0d47a1;
    transform: scale(0.95);
    box-shadow: none;
}
.version {
    font-size: 14px;
    text-align: center;
    margin: 2px 0;
    color: #aaa;
}
@media screen and (orientation: landscape) {
    .container { flex-direction: column; }
    .bottom { flex-direction: column; }
    .controls { flex-direction: row; flex-wrap: wrap; }
    .keys-area {
        margin-top: 1vmin;
    }
    .keys {
        grid-template-columns: repeat(6, 1fr);
        grid-auto-rows: 6vmin;
        gap: 6vmin;
    }
    .key {
        font-size: 4vmin;
    }
    .undo-button {
        min-width: 10vmin;
    }
    .undo-button .icon {
        font-size: 4vmin;
    }
    .undo-button .text {
        font-size: 2.5vmin;
    }
    .score {
        max-height: 35vh;
    }
    .score img {
        height: 22vh !important;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="top" id="top"></div>
    <div class="bottom">
        <div class="controls">
            <button onclick="addTeam()">Team Ôºã</button>
            <button onclick="removeTeam()">Team ‚àí</button>
            <div id="modeToggle" class="mode-toggle">Mode</div>
            <button onclick="forceReload()">ÂÜçË™≠Ëæº</button>
            <button onclick="resetScores()" style="color:#e53935;">ÂæóÁÇπ„É™„Çª„ÉÉ„Éà</button>
            <!-- ‚òÖ „ÉÜ„Éº„ÉûÈÅ∏Êäû -->
            <select id="themeSelector" class="theme-selector" onchange="changeTheme(this.value)">
                <option value="">default</option>
                <option value="numbers_colorful">colorful</option>
                <option value="numbers_tokyotower">tokyo tower</option>
                <option value="numbers_gradation">gradation</option>
                <option value="numbers_tokyotowerwalking">tokyo tower walking</option>
                <option value="numbers_minato-ku">minato-ku</option>
                <option value="numbers_manga">manga</option>
                <option value="numbers_stone">stone</option>
                <option value="numbers_working">working</option>
            </select>
        </div>
        <div class="keys-area">
            <div class="keys" id="keys"></div>
            <button class="undo-button" onclick="undo()">
                <span class="icon">‚Ü©</span>
                <span class="text">1„Å§Ââç„Å´Êàª„Åô</span>
            </button>
        </div>
        <div class="version">Ver 1.7.1</div>
    </div>
</div>

<script>
const EMPTY_MEMBERS = () => ["","","","","",""];
let teams = [
    { name: "„ÉÅ„Éº„É†A", score: 0, misses: 0, members: EMPTY_MEMBERS(), currentMember: 0 },
    { name: "„ÉÅ„Éº„É†B", score: 0, misses: 0, members: EMPTY_MEMBERS(), currentMember: 0 },
];
let selectedTeam = 0;
let addMode = true;
let history = [];
let currentTheme = ""; // „Éá„Éï„Ç©„É´„Éà„ÅØÁõ¥‰∏ã

const topElement = document.getElementById("top");
const keys = document.getElementById("keys");
const modeToggle = document.getElementById("modeToggle");

function getScoreImageURL(digit) {
    if (currentTheme === "") {
        return `https://github.com/atsushikose-arch/molkky-score-images/raw/main/score_${digit}.png`;
    } else {
        return `https://github.com/atsushikose-arch/molkky-score-images/raw/main/${currentTheme}/score_${digit}.png`;
    }
}

function renderScore(team) {
    const scoreDiv = document.createElement("div");
    scoreDiv.className = "score";
    const digits = team.score.toString().split("");
    digits.forEach(d => {
        const img = document.createElement("img");
        img.src = getScoreImageURL(d);
        img.alt = d;
        scoreDiv.appendChild(img);
    });
    return scoreDiv;
}

function render() {
    topElement.innerHTML = "";
    teams.forEach((team, index) => {
        const div = document.createElement("div");
        div.className = "team" + (index === selectedTeam ? " selected" : "");

        // „É°„É≥„Éê„Éº„É™„Çπ„ÉàÔºàÂ∑¶ÂÅ¥Ôºâ
        const memberList = document.createElement("div");
        memberList.className = "member-list";
        const filledCount = team.members.filter(m => m.trim() !== "").length;
        let filledIndex = 0;
        team.members.forEach((member, mi) => {
            const inp = document.createElement("input");
            inp.type = "text";
            inp.className = "member-input";
            inp.value = member;
            inp.maxLength = 20;
            inp.placeholder = "ÂêçÂâç";
            if (member.trim() !== "") {
                if (filledCount > 0 && filledIndex === team.currentMember % filledCount) {
                    inp.classList.add("current");
                }
                filledIndex++;
            }
            inp.addEventListener("input", e => { team.members[mi] = e.target.value; });
            inp.addEventListener("click", e => e.stopPropagation());
            inp.addEventListener("pointerdown", e => e.stopPropagation(), { passive: true });
            memberList.appendChild(inp);
        });

        // „ÉÅ„Éº„É†„É°„Ç§„É≥„Ç®„É™„Ç¢
        const teamMain = document.createElement("div");
        teamMain.className = "team-main";

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.className = "team-name";
        nameInput.value = team.name;
        nameInput.addEventListener("input", (e) => { team.name = e.target.value; });

        const scoreImg = renderScore(team);

        const misses = document.createElement("div");
        misses.className = "misses";
        for (let i = 0; i < 3; i++) {
            const miss = document.createElement("div");
            miss.className = "miss" + (i < team.misses ? " active" : "");
            miss.textContent = "√ó";
            miss.onclick = (e) => {
                e.stopPropagation();
                team.misses += i < team.misses ? -1 : 1;
                render();
            };
            misses.appendChild(miss);
        }

        const scoreRow = document.createElement("div");
        scoreRow.className = "score-row";
        scoreRow.appendChild(scoreImg);
        scoreRow.appendChild(misses);

        teamMain.appendChild(nameInput);
        teamMain.appendChild(scoreRow);

        div.appendChild(memberList);
        div.appendChild(teamMain);
        div.onclick = (e) => {
            if (e.target.classList.contains("team-name") || e.target.classList.contains("member-input")) return;
            selectedTeam = index;
            render();
        };
        topElement.appendChild(div);
    });
    updateModeDisplay();
}

function updateModeDisplay() {
    modeToggle.textContent = addMode ? "Âä†ÁÇπ Mode" : "Ê∏õÁÇπ Mode";
}
modeToggle.onclick = () => { addMode = !addMode; updateModeDisplay(); };

function createKeys() {
    if (!keys.hasChildNodes()) {
        for (let i = 1; i <= 12; i++) {
            const btn = document.createElement("div");
            btn.className = "key";
            btn.textContent = i;
            btn.onclick = () => applyScore(i);
            keys.appendChild(btn);
        }
    }
}

function applyScore(value) {
    const team = teams[selectedTeam];
    history.push(JSON.parse(JSON.stringify(teams)));
    if (addMode) {
        team.score += value;
        if (team.score > 50) team.score = 25;
        team.misses = 0;
        if (team.score === 50) celebrate(team.name);
        const filledCount = team.members.filter(m => m.trim() !== "").length;
        if (filledCount > 0) team.currentMember = (team.currentMember + 1) % filledCount;
    } else {
        team.score = Math.max(0, team.score - value);
    }
    render();
}

function celebrate(teamName) {
    const overlay = document.createElement('div');
    overlay.id = 'celebrate-overlay';
    Object.assign(overlay.style, {
        position: 'fixed', top: '0', left: '0',
        width: '100%', height: '100%',
        zIndex: '1000', display: 'flex',
        flexDirection: 'column', justifyContent: 'center', alignItems: 'center',
        background: 'rgba(0,0,0,0.65)', cursor: 'pointer',
    });

    const canvas = document.createElement('canvas');
    Object.assign(canvas.style, { position: 'absolute', top: '0', left: '0', width: '100%', height: '100%' });
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const msg = document.createElement('div');
    Object.assign(msg.style, {
        position: 'relative', zIndex: '1',
        color: '#fff', fontFamily: "'Rounded M+ 1c', sans-serif",
        fontSize: '10vmin', fontWeight: 'bold', textAlign: 'center',
        textShadow: '0 0 30px rgba(255,220,0,0.9)',
        lineHeight: '1.4',
    });
    msg.innerHTML = `üèÜ<br>${teamName}<br><span style="font-size:7vmin">50ÁÇπ ÈÅîÊàêÔºÅ</span>`;

    const hint = document.createElement('div');
    Object.assign(hint.style, {
        position: 'relative', zIndex: '1',
        color: 'rgba(255,255,255,0.6)', fontFamily: "'Rounded M+ 1c', sans-serif",
        fontSize: '3.5vmin', marginTop: '6vmin',
    });
    hint.textContent = '„Çø„ÉÉ„Éó„ÅßÈñâ„Åò„Çã';

    overlay.appendChild(canvas);
    overlay.appendChild(msg);
    overlay.appendChild(hint);
    document.body.appendChild(overlay);

    const ctx = canvas.getContext('2d');
    const particles = [];
    const COLORS = ['#ff6b6b','#ffd93d','#6bcb77','#4d96ff','#ff922b','#f06595','#74c0fc','#ffe066','#fff'];

    function burst(x, y) {
        for (let i = 0; i < 70; i++) {
            const angle = (Math.PI * 2 / 70) * i + Math.random() * 0.2;
            const speed = 2 + Math.random() * 6;
            particles.push({
                x, y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                alpha: 1,
                color: COLORS[Math.floor(Math.random() * COLORS.length)],
                size: 3 + Math.random() * 3,
                decay: 0.012 + Math.random() * 0.01,
            });
        }
    }

    const launches = [0, 300, 600, 900, 1200, 1500, 1800, 2200];
    launches.forEach(delay => setTimeout(() => {
        burst(canvas.width * (0.2 + Math.random() * 0.6), canvas.height * (0.1 + Math.random() * 0.5));
    }, delay));

    function animate() {
        if (!document.getElementById('celebrate-overlay')) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.x += p.vx; p.y += p.vy;
            p.vy += 0.12;
            p.alpha -= p.decay;
            if (p.alpha <= 0) { particles.splice(i, 1); continue; }
            ctx.save();
            ctx.globalAlpha = p.alpha;
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }
        requestAnimationFrame(animate);
    }
    animate();

    const autoClose = setTimeout(() => overlay.remove(), 6000);
    overlay.onclick = () => { clearTimeout(autoClose); overlay.remove(); };
}

function addTeam() {
    if (teams.length >= 10) return;
    teams.push({ name: `„ÉÅ„Éº„É†${String.fromCharCode(65 + teams.length)}`, score: 0, misses: 0, members: EMPTY_MEMBERS(), currentMember: 0 });
    render();
}
function removeTeam() {
    if (teams.length <= 1) return;
    teams.splice(selectedTeam,1);
    selectedTeam=Math.max(0, teams.length-1);
    render();
}
function undo() {
    if (history.length === 0) return;
    teams = history.pop();
    selectedTeam=Math.min(selectedTeam, teams.length-1);
    render();
}
function changeTheme(theme) {
    currentTheme = theme;
    render();
}
function forceReload() {
    if (!confirm('ÊúÄÊñ∞Áâà„Å´„É™„É≠„Éº„Éâ„Åó„Åæ„Åô„ÅãÔºü\nÔºà„ÉÅ„Éº„É†Âêç„Éª„ÉÅ„Éº„É†Êï∞„Éª„Çπ„Ç≥„Ç¢„Åå„Åô„Åπ„Å¶„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô„ÄÇÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„ÇìÔºâ')) return;
    const url = location.href.split('?')[0] + '?v=' + Date.now();
    location.href = url;
}
function resetScores() {
    if (!confirm('ÂÖ®„ÉÅ„Éº„É†„ÅÆÂæóÁÇπ„Å®„Éü„Çπ„Çí„Çº„É≠„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) return;
    history.push(JSON.parse(JSON.stringify(teams)));
    teams.forEach(t => { t.score = 0; t.misses = 0; t.currentMember = 0; });
    render();
}

render();
createKeys();
window.addEventListener("resize", render);
</script>
</body>
</html>
